# 📋 v0.1 版本配置说明

## ✅ 代码状态

- ✅ **代码已提交到本地 Git**
- ⚠️ **GitHub 推送失败**（网络连接问题，等网络恢复后会自动推送）
- ✅ **所有修复已完成**

---

## 🔧 问题 1：Unlock 报错 "Internal server error"

### 原因

点击 unlock 时出现错误的原因是：
- Railway 部署环境中 **`RECEIVER_ADDRESS` 环境变量未设置**
- 代码检查到未设置后抛出错误，返回 500 错误

### 解决方案

**在 Railway 设置环境变量：**

1. 登录 [Railway](https://railway.app)
2. 进入你的项目
3. 点击 **Settings** → **Variables**
4. 添加以下**必需**的环境变量：

```env
PORT=3000
NODE_ENV=production
NETWORK=base-mainnet
BASE_RPC_URL=https://mainnet.base.org
RECEIVER_ADDRESS=0x你的钱包地址（必须！）
```

5. 设置后 Railway 会自动重新部署
6. 等待部署完成后测试 unlock 功能

### 验证修复

访问健康检查端点：
```bash
curl https://your-app.up.railway.app/health
```

应该返回：
```json
{
  "status": "ok",
  "receiverAddress": "0x..."  // 如果显示 "Not configured" 说明未设置
}
```

---

## 📦 问题 2：资料存储方案

### ✅ 已解决的问题

1. **资料文件已从 Git 中移除**
   - ✅ `materials/downloads/` 目录已添加到 `.gitignore`
   - ✅ 资料文件不会提交到 GitHub 公开仓库
   - ✅ 只有 `materials-config.json`（元数据）会提交

2. **已实现上传和下载 API**
   - ✅ `POST /api/admin/upload` - 上传资料
   - ✅ `GET /api/download/:materialId` - 下载资料（需支付验证）

### ⚠️ 当前限制

**Railway 容器文件系统是临时的：**
- ❌ 服务器重启后文件会丢失
- ❌ 重新部署后文件会丢失

### ✅ 推荐解决方案：配置 Railway Volume

#### 步骤 1：创建 Volume

1. Railway 项目 → **New** → **Volume**
2. 名称：`materials-storage`
3. 挂载路径：`/app/materials`
4. 点击 **Create**

#### 步骤 2：上传资料

**设置环境变量（本地）：**
```bash
export RAILWAY_URL=https://your-app.up.railway.app
export ADMIN_KEY=your-admin-key  # 在 Railway 环境变量中设置
```

**上传文件：**
```bash
./upload-material.sh ./my-file.pdf m1 "资料标题" "资料描述"
```

**或使用 curl：**
```bash
curl -X POST https://your-app.up.railway.app/api/admin/upload \
  -H "X-Admin-Key: your-admin-key" \
  -H "X-Material-ID: m1" \
  -H "X-Filename: my-file.pdf" \
  -H "X-Title: 资料标题" \
  -H "Content-Type: application/octet-stream" \
  --data-binary @./my-file.pdf
```

#### 步骤 3：验证

上传后，文件会保存在 Volume 中，即使重启也不会丢失。

---

## 📝 完整配置清单

### Railway 环境变量（必须设置）

```env
# 服务器配置
PORT=3000
NODE_ENV=production

# 网络配置
NETWORK=base-mainnet
BASE_RPC_URL=https://mainnet.base.org

# 支付配置（必须！）
RECEIVER_ADDRESS=0x你的钱包地址

# 管理员配置（可选，用于上传资料）
ADMIN_KEY=你的管理员密钥
```

### Railway Volume（推荐配置）

- **名称：** `materials-storage`
- **挂载路径：** `/app/materials`
- **用途：** 持久化存储资料文件

---

## 🚀 立即执行步骤

### 1. 修复 Unlock 错误（必须）

1. Railway → Settings → Variables
2. 添加 `RECEIVER_ADDRESS=0x你的钱包地址`
3. 等待自动重新部署
4. 测试 unlock 功能

### 2. 配置资料存储（推荐）

1. Railway → New → Volume
2. 创建 Volume：`materials-storage`，挂载到 `/app/materials`
3. 在 Railway 环境变量中添加 `ADMIN_KEY=你的密钥`
4. 使用上传脚本上传资料文件

---

## 📚 详细文档

- `DEPLOYMENT_CONFIG_GUIDE.md` - 完整部署配置指南（英文）
- `MATERIALS_STORAGE_GUIDE.md` - 资料存储详细说明
- `FIXES_SUMMARY.md` - 修复总结

---

## ❓ 常见问题

### Q: 为什么资料文件不能放在 GitHub？

A: 因为 GitHub 是公开仓库，如果资料文件在仓库中，任何人都可以直接访问，付费解锁就失去意义了。

### Q: 资料文件存储在哪里？

A: 
- **当前：** Railway 容器文件系统（临时，重启会丢失）
- **推荐：** Railway Volume（持久化，重启不丢失）
- **长期：** 云存储（S3/R2/OSS）

### Q: 如何上传资料？

A: 使用 `./upload-material.sh` 脚本或 curl 命令，需要设置 `ADMIN_KEY` 环境变量。

### Q: 用户如何下载资料？

A: 用户支付后，通过 `GET /api/download/:materialId` API 下载，服务器会验证支付状态。

---

## 🆘 需要帮助？

如果遇到问题：

1. **查看 Railway 日志**
   - Railway → Deployments → 最新部署 → View Logs

2. **检查环境变量**
   - 确认 `RECEIVER_ADDRESS` 已设置
   - 确认值正确（无多余空格）

3. **测试健康检查**
   ```bash
   curl https://your-app.up.railway.app/health
   ```

告诉我具体错误，我可以进一步诊断！


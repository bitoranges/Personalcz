# 🚨 快速修复指南：Unlock 报错 "Internal server error"

## 问题现象

- 点击 MetaMask 钱包 → 直接报错 "Internal server error"
- 点击 Binance 钱包 → 弹出界面，点击取消后也报错 "Internal server error"
- 控制台显示：`[x402-client] Unlock response status: 500`

## 根本原因

**Railway 部署环境中 `RECEIVER_ADDRESS` 环境变量未设置！**

当用户点击钱包（无论是否连接成功），前端都会调用 `/api/unlock` 端点。如果 `RECEIVER_ADDRESS` 未设置，服务器会抛出错误并返回 500 错误。

## ✅ 解决方案（5分钟修复）

### 步骤 1：登录 Railway

1. 访问 [Railway](https://railway.app)
2. 登录你的账号
3. 进入你的项目

### 步骤 2：设置环境变量

1. 点击左侧菜单 **Settings**
2. 点击 **Variables** 标签
3. 点击 **+ New Variable** 按钮
4. 添加以下环境变量：

```env
RECEIVER_ADDRESS=0x你的钱包地址
```

**重要：**
- 将 `0x你的钱包地址` 替换为你的实际 Base 网络钱包地址
- 地址格式：`0x` 开头的 42 个字符
- 确保没有多余的空格

### 步骤 3：验证其他环境变量

确保以下环境变量也已设置：

```env
PORT=3000
NODE_ENV=production
NETWORK=base-mainnet
BASE_RPC_URL=https://mainnet.base.org
RECEIVER_ADDRESS=0x你的钱包地址（必须！）
```

### 步骤 4：等待自动重新部署

- Railway 检测到环境变量变化后会自动重新部署
- 等待部署完成（通常 1-2 分钟）

### 步骤 5：验证修复

1. **检查健康检查端点**
   ```bash
   curl https://your-app.up.railway.app/health
   ```
   
   应该返回：
   ```json
   {
     "status": "ok",
     "receiverAddress": "0x..."  // 不是 "Not configured"
   }
   ```

2. **测试 Unlock 功能**
   - 打开网站
   - 点击 "Unlock All Access"
   - 选择钱包（MetaMask 或 Binance）
   - **应该不再出现 "Internal server error"**
   - 应该显示支付要求或钱包连接界面

## 🔍 如果问题仍然存在

### 检查 1：确认环境变量已设置

1. Railway → Settings → Variables
2. 确认 `RECEIVER_ADDRESS` 存在且值正确
3. 检查是否有拼写错误或多余空格

### 检查 2：查看 Railway 日志

1. Railway → Deployments → 最新部署
2. 点击 **View Logs**
3. 查找以下错误信息：
   - `❌ RECEIVER_ADDRESS not configured!`
   - `RECEIVER_ADDRESS not set`

### 检查 3：手动触发重新部署

如果环境变量已设置但问题仍然存在：

1. Railway → Deployments
2. 点击 **Redeploy** 按钮
3. 等待部署完成

## 📋 完整环境变量清单

确保以下所有环境变量都已设置：

```env
# 服务器配置
PORT=3000
NODE_ENV=production

# 网络配置
NETWORK=base-mainnet
BASE_RPC_URL=https://mainnet.base.org

# 支付配置（必须！）
RECEIVER_ADDRESS=0x你的钱包地址

# 管理员配置（可选，用于上传资料）
ADMIN_KEY=你的管理员密钥
```

## 🎯 预期行为（修复后）

### MetaMask 钱包

1. 点击 "Unlock All Access"
2. 选择 MetaMask
3. MetaMask 弹出连接请求
4. 用户确认后，显示支付界面或直接解锁（如果已支付）

### Binance 钱包

1. 点击 "Unlock All Access"
2. 选择 Binance Wallet
3. Binance 弹出连接请求
4. 用户确认后，显示支付界面
5. **如果用户点击取消，应该优雅地处理，不显示错误**

## 📞 需要帮助？

如果按照以上步骤操作后问题仍然存在：

1. **复制 Railway 日志**（最新部署的日志）
2. **复制浏览器控制台错误**（F12 → Console）
3. **告诉我具体错误信息**

我可以进一步诊断问题！

